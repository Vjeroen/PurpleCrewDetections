$schema: https://schema.management.azure.com/schemas/2019-01-01/deploymentTemplate.json#
contentVersion: 1.0.0.0
parameters: {}
resources:
- type: Microsoft.OperationalInsights/workspaces/providers/alertRules
  apiVersion: 2022-12-01-preview
  name: "[parameters('workspaceName')]/Microsoft.SecurityInsights/[Purple Crew]: Suspicious Core Windows Binary Execution"
  kind: Scheduled
  properties:
    displayName: "[Purple Crew]: Suspicious Core Windows Binary Execution"
    description: Detects execution of critical Windows binaries (e.g., lsass.exe, csrss.exe) under unexpected logon sessions, which could indicate suspicious activity."
    severity: High
    enabled: true
    query: |
      parse_sysmon
      | where EventID == 1 // Process creation event
      | where Image matches regex @"(?i)\\(system|smss|wininit|lsass|ism|services|csrss|lsaiso)\.exe$" // Matches core binaries
      | where LogonId !in ("0x3e7", "0x3e5", "0x3e4") // Exclude System, Local Service, and Network Service accounts
      | extend SuspiciousBinary = extract(@"[^\\]+$", 0, Image) // Extracts just the binary name
      | project TimeGenerated, Computer, User, LogonId, Image, SuspiciousBinary
    queryFrequency: PT1H
    queryPeriod: PT1H
    triggerOperator: GreaterThan
    triggerThreshold: 0
    tactics:
    - DefenseEvasion
    - PrivilegeEscalation
    techniques:
    - T1059
    - T1566
    alertRuleTemplateName: "[Purple Crew]: Suspicious Core Windows Binary Execution"
    metadata:
      author: Purple Crew
      source: PurpleCrew Sentinel
      supportingTactics: []
    suppressionEnabled: false
    suppressionDuration: PT1H
    eventGroupingSettings:
      aggregationKind: AlertPerResult
    customDetails: {}
